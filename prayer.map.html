<!DOCTYPE html>
<html lang="en">
<head>
  <!-- =========================================================
       XRPL PRAYER & INTEGRITY MAP v2
       Frontend-only. Uses a Render-style proxy for XRPL data.
       No secrets. No wallet keys. Pure reads + visualization.
       ========================================================= -->

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>XRPL Prayer & Integrity Map · Jesus Christ Saves Token</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=UnifrakturCook:wght@700&display=swap"
    rel="stylesheet"
  />

  <style>
    /* ============================================
       GLOBAL LAYOUT
       ============================================ */

    :root {
      --bg-main: #020817;
      --bg-panel: rgba(4, 10, 25, 0.98);
      --bg-chip: rgba(13, 26, 52, 1);
      --border-soft: rgba(148, 163, 253, 0.26);
      --border-subtle: rgba(148, 163, 253, 0.11);
      --accent-gold: #ffd700;
      --accent-blue: #38bdf8;
      --accent-red: #f97373;
      --accent-green: #4ade80;
      --accent-amber: #facc15;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --radius-xl: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 14px 40px rgba(15, 23, 42, 0.9);
      --font-main: "Montserrat", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      --font-title: "UnifrakturCook", system-ui, -apple-system, serif;
      --transition-fast: 0.18s ease-out;
      --transition-med: 0.26s ease-out;
      --z-map: 1;
      --z-panels: 600;
      --z-toasts: 1200;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      background: var(--bg-main);
      color: var(--text-main);
      font-family: var(--font-main);
    }

    body {
      overflow: hidden;
      position: relative;
    }

    #app-root {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.04), transparent),
        radial-gradient(circle at top right, rgba(250, 204, 21, 0.035), transparent),
        var(--bg-main);
    }

    /* ============================================
       MAP
       ============================================ */

    #map {
      position: absolute;
      inset: 0;
      z-index: var(--z-map);
    }

    .leaflet-container {
      background: transparent;
    }

    /* Keep attribution visible to satisfy OSM; you can restyle if needed */
    .leaflet-control-attribution {
      background: rgba(2, 6, 23, 0.88) !important;
      color: var(--text-soft) !important;
      border-radius: 999px !important;
      padding: 2px 10px !important;
      font-size: 9px !important;
      backdrop-filter: blur(6px);
    }

    .leaflet-control-zoom a {
      background: rgba(2, 6, 23, 0.98);
      color: var(--accent-blue);
      border: 1px solid rgba(148, 163, 253, 0.16);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.9);
    }

    /* ============================================
       TOP BRAND BAR
       ============================================ */

    #top-bar {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 18px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-radius: 999px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(2, 6, 23, 0.98));
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      z-index: var(--z-panels);
      max-width: 96vw;
    }

    #top-bar img {
      width: 26px;
      height: 26px;
      border-radius: 999px;
    }

    #top-bar-title {
      display: flex;
      flex-direction: column;
      line-height: 1.25;
    }

    #top-bar-title span.label {
      font-size: 10px;
      color: var(--accent-blue);
      letter-spacing: 0.14em;
      text-transform: uppercase;
    }

    #top-bar-title span.main {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent-gold);
      font-family: var(--font-title);
    }

    #top-bar-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-left: 6px;
    }

    .pill {
      padding: 4px 9px;
      border-radius: 999px;
      font-size: 9px;
      border: 1px solid var(--border-subtle);
      color: var(--text-soft);
      background: rgba(4, 7, 20, 0.98);
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      display: inline-block;
      background: var(--accent-blue);
    }

    .pill.safe span.dot {
      background: var(--accent-green);
    }

    .pill.warn span.dot {
      background: var(--accent-amber);
    }

    .pill.risk span.dot {
      background: var(--accent-red);
    }

    /* ============================================
       LEFT CONTROL PANEL
       ============================================ */

    #left-panel {
      position: absolute;
      top: 62px;
      left: 18px;
      width: 290px;
      max-height: calc(100vh - 80px);
      padding: 14px 14px 10px 14px;
      border-radius: var(--radius-xl);
      background: var(--bg-panel);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      z-index: var(--z-panels);
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: hidden;
    }

    #left-panel-header {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    #left-panel-header h2 {
      font-size: 14px;
      color: var(--accent-gold);
      font-weight: 700;
    }

    #left-panel-header p {
      font-size: 10px;
      color: var(--text-soft);
    }

    #filters {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin-top: 4px;
      font-size: 10px;
    }

    .filter-chip {
      padding: 5px 7px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-chip);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      transition: all var(--transition-fast);
      user-select: none;
    }

    .filter-chip span.square {
      width: 8px;
      height: 8px;
      border-radius: 2px;
      background: var(--accent-blue);
    }

    .filter-chip[data-active="true"] {
      color: var(--accent-blue);
      border-color: var(--accent-blue);
      box-shadow: 0 4px 12px rgba(56, 189, 248, 0.24);
      transform: translateY(-1px);
    }

    .filter-chip.safe span.square {
      background: var(--accent-green);
    }

    .filter-chip.warn span.square {
      background: var(--accent-amber);
    }

    .filter-chip.risk span.square {
      background: var(--accent-red);
    }

    #legend {
      margin-top: 2px;
      padding: 6px 7px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: rgba(3, 7, 18, 0.98);
      font-size: 9px;
      color: var(--text-soft);
      display: grid;
      gap: 3px;
    }

    #legend strong {
      color: var(--accent-blue);
      font-weight: 600;
      font-size: 9px;
    }

    #stats-mini {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin-top: 4px;
      font-size: 9px;
    }

    .mini-card {
      padding: 6px 7px;
      border-radius: var(--radius-md);
      background: rgba(2, 6, 23, 0.98);
      border: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .mini-label {
      color: var(--text-soft);
      font-size: 8px;
    }

    .mini-value {
      color: var(--accent-gold);
      font-size: 11px;
      font-weight: 600;
    }

    /* ============================================
       RIGHT DETAIL PANEL
       ============================================ */

    #right-panel {
      position: absolute;
      top: 62px;
      right: 18px;
      width: 320px;
      max-height: calc(100vh - 80px);
      padding: 12px 12px 10px 12px;
      border-radius: var(--radius-xl);
      background: var(--bg-panel);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      z-index: var(--z-panels);
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: hidden;
    }

    #right-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    #right-header-title {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    #right-header-title span.label {
      font-size: 9px;
      color: var(--accent-blue);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    #right-header-title span.main {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent-gold);
    }

    #right-badge {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 8px;
      border: 1px solid var(--border-soft);
      color: var(--accent-blue);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    #detail-scroll {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 3px;
      display: grid;
      gap: 6px;
      font-size: 9px;
      color: var(--text-soft);
    }

    #detail-scroll::-webkit-scrollbar {
      width: 4px;
    }

    #detail-scroll::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 253, 0.32);
      border-radius: 999px;
    }

    .detail-block {
      padding: 6px 7px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: rgba(3, 7, 18, 0.98);
      display: grid;
      gap: 3px;
    }

    .detail-block h3 {
      font-size: 10px;
      font-weight: 600;
      color: var(--accent-blue);
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .detail-label {
      color: var(--text-soft);
    }

    .detail-value {
      color: var(--accent-gold);
    }

    .risk-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 8px;
      border: 1px solid var(--border-subtle);
      color: var(--text-soft);
    }

    .risk-pill.safe {
      color: var(--accent-green);
      border-color: var(--accent-green);
    }

    .risk-pill.warn {
      color: var(--accent-amber);
      border-color: var(--accent-amber);
    }

    .risk-pill.risk {
      color: var(--accent-red);
      border-color: var(--accent-red);
    }

    /* ============================================
       PRAYER STRIP (BOTTOM)
       ============================================ */

    #prayer-strip {
      position: absolute;
      left: 50%;
      bottom: 10px;
      transform: translateX(-50%);
      z-index: var(--z-panels);
      padding: 8px 14px;
      border-radius: 999px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), rgba(2, 6, 23, 0.98));
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      gap: 10px;
      max-width: 96vw;
      overflow: hidden;
      font-size: 9px;
      color: var(--text-soft);
    }

    #prayer-strip strong {
      color: var(--accent-gold);
      font-family: var(--font-title);
      font-size: 12px;
    }

    #prayer-strip-text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #prayer-strip a {
      color: var(--accent-blue);
      text-decoration: none;
      font-weight: 600;
      font-size: 9px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.4);
      background: rgba(2, 6, 23, 0.98);
      flex-shrink: 0;
    }

    #prayer-strip a:hover {
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.6);
    }

    /* ============================================
       TOAST / ALERT
       ============================================ */

    #toast-container {
      position: absolute;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      z-index: var(--z-toasts);
      display: flex;
      flex-direction: column;
      gap: 6px;
      pointer-events: none;
    }

    .toast {
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 9px;
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), rgba(2, 6, 23, 0.98));
      color: var(--text-soft);
      box-shadow: var(--shadow-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      pointer-events: auto;
      opacity: 0;
      transform: translateY(-4px);
      transition: all var(--transition-med);
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-blue);
    }

    .toast[data-type="error"] span.dot {
      background: var(--accent-red);
    }

    .toast[data-type="success"] span.dot {
      background: var(--accent-green);
    }

    /* ============================================
       RESPONSIVE
       ============================================ */

    @media (max-width: 880px) {
      #left-panel {
        width: 64vw;
        max-width: 360px;
      }

      #right-panel {
        display: none;
      }

      #top-bar {
        max-width: 98vw;
        padding: 8px 10px;
      }
    }

    @media (max-width: 640px) {
      #left-panel {
        width: calc(100vw - 18px * 2);
        left: 50%;
        transform: translateX(-50%);
        top: 64px;
      }

      #prayer-strip {
        bottom: 8px;
        padding-inline: 9px;
      }

      #top-bar-pills {
        display: none;
      }
    }
  </style>
</head>
<body>
<div id="app-root">
  <div id="map"></div>

  <!-- Top Brand Bar -->
  <div id="top-bar">
    <img src="https://jesuschristsavestoken.com/jcs-logo.png" alt="JCS Logo">
    <div id="top-bar-title">
      <span class="label">XRPL Integrity Overlay</span>
      <span class="main">Jesus Christ Saves · Prayer & Risk Map</span>
    </div>
    <div id="top-bar-pills">
      <div class="pill"><span class="dot"></span>Live AMM / DEX Liquidity</div>
      <div class="pill safe"><span class="dot"></span>Trusted Issuers</div>
      <div class="pill warn"><span class="dot"></span>Watchlist Zones</div>
      <div class="pill risk"><span class="dot"></span>High-Risk Origins</div>
    </div>
  </div>

  <!-- Left Panel: Filters and Overview -->
  <aside id="left-panel">
    <div id="left-panel-header">
      <h2>Layers & Filters</h2>
      <p>Select what to visualize. Data from your XRPL proxy (read-only).</p>
    </div>

    <div id="filters">
      <div class="filter-chip" data-filter="liquidity" data-active="true">
        <span class="square"></span>
        Liquidity heat
      </div>
      <div class="filter-chip safe" data-filter="trusted" data-active="true">
        <span class="square"></span>
        Trusted tokens
      </div>
      <div class="filter-chip warn" data-filter="watch" data-active="true">
        <span class="square"></span>
        Watchlist
      </div>
      <div class="filter-chip risk" data-filter="risk" data-active="true">
        <span class="square"></span>
        High risk
      </div>
      <div class="filter-chip" data-filter="prayers" data-active="true">
        <span class="square"></span>
        Prayer signals
      </div>
      <div class="filter-chip" data-filter="amm" data-active="true">
        <span class="square"></span>
        AMM pools
      </div>
    </div>

    <div id="legend">
      <strong>Legend</strong>
      <div>• Circles: Liquidity intensity by region.</div>
      <div>• Shield icons: issuer origin and reputation tier.</div>
      <div>• Red markers: clusters from tokens with low liquidity / no metadata.</div>
      <div>• Tap clusters to inspect projects anchored there.</div>
    </div>

    <div id="stats-mini">
      <div class="mini-card">
        <div class="mini-label">Tracked tokens</div>
        <div class="mini-value" id="stat-tokens">—</div>
      </div>
      <div class="mini-card">
        <div class="mini-label">Trusted issuers</div>
        <div class="mini-value" id="stat-trusted">—</div>
      </div>
      <div class="mini-card">
        <div class="mini-label">Watch / risk</div>
        <div class="mini-value" id="stat-risk">—</div>
      </div>
      <div class="mini-card">
        <div class="mini-label">AMM pools mapped</div>
        <div class="mini-value" id="stat-pools">—</div>
      </div>
    </div>
  </aside>

  <!-- Right Panel: Dynamic Detail -->
  <aside id="right-panel">
    <div id="right-header">
      <div id="right-header-title">
        <span class="label">Selection</span>
        <span class="main" id="selection-title">Click a hotspot or token marker</span>
      </div>
      <div id="right-badge">
        <span>Risk Matrix</span>
      </div>
    </div>
    <div id="detail-scroll">
      <div class="detail-block">
        <h3>How this map works</h3>
        <p>
          This interface reads curated metrics from an XRPL indexer proxy you control.
          No keys, no signing, read-only. It scores tokens by:
        </p>
        <ul>
          <li>Verified domain and xrp-ledger.toml metadata.</li>
          <li>AMM and order-book liquidity depth.</li>
          <li>Issuer history, freezes, blackhole status.</li>
          <li>Known scams list you maintain server-side.</li>
        </ul>
        <p>
          Use it to spot strong, transparent projects and avoid zero-liquidity or red-flag clusters.
        </p>
      </div>
      <div class="detail-block">
        <h3>Quick tiers</h3>
        <div class="detail-row">
          <div class="detail-label">Trusted</div>
          <div class="detail-value">Score ≥ 80 / 100</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">Watch</div>
          <div class="detail-value">40–79 / 100</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">High risk</div>
          <div class="detail-value">0–39 / 100</div>
        </div>
      </div>
      <div class="detail-block">
        <h3>Note</h3>
        <p>
          This is an informational map. It does not replace your own verification.
          No financial advice. You define the server-side rules and lists.
        </p>
      </div>
    </div>
  </aside>

  <!-- Prayer Strip / Verse -->
  <div id="prayer-strip">
    <strong>✝</strong>
    <div id="prayer-strip-text">
      “Let your light so shine before men, that they may see your good works,
      and glorify your Father which is in heaven.” — Matthew 5:16
    </div>
    <a href="verify.html" target="_blank" rel="noopener">Sign the Ledger</a>
  </div>

  <!-- Toasts -->
  <div id="toast-container"></div>
</div>

<!-- Libraries -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  /************************************************************
   * XRPL PRAYER & INTEGRITY MAP v2
   * ----------------------------------------------------------
   * This file is intentionally verbose and modular.
   * All XRPL reads flow through a single proxy:
   *   const XRPL_PROXY_BASE = "https://your-render-proxy.example.com";
   *
   * Expected proxy responsibilities (server-side, not in this file):
   *   - Crawl XRPL AMMs, order books, trustlines.
   *   - Enrich issuers via xrp-ledger.toml, Bithomp/XRPLMeta, KYC flags.
   *   - Assign:
   *       • reputationScore (0–100)
   *       • riskTier: "trusted" | "watch" | "risk"
   *       • geoHints: { lat, lng, label } from issuer domain / metadata.
   *       • ammPools by region with liquidity_usd.
   *       • flaggedReasons[] for watch/risk tokens.
   *   - Publish aggregated JSON for this UI.
   ************************************************************/

  /* =========================
     CONFIG
     ========================= */

  const XRPL_PROXY_BASE = "https://your-render-proxy.example.com"; // replace with your proxy base

  // Endpoints you must implement on your proxy:
  //
  // GET /api/map/overview
  // -> {
  //      "generated_at": "2025-11-08T12:00:00Z",
  //      "summary": {
  //         "token_count": 123,
  //         "trusted_count": 23,
  //         "watch_count": 47,
  //         "risk_count": 53,
  //         "amm_pools": 38
  //      },
  //      "pools": [
  //         {
  //           "id": "AMM-1",
  //           "lat": 37.7749,
  //           "lng": -122.4194,
  //           "liquidity_usd": 250000.12,
  //           "token_pairs": [
  //             { "base": "JCS", "quote": "XRP" },
  //             { "base": "XYZ", "quote": "XRP" }
  //           ],
  //           "region_label": "US · West Coast",
  //           "heat": 0.92
  //         },
  //         ...
  //      ],
  //      "issuers": [
  //         {
  //           "issuer": "rXXXXXXXX",
  //           "domain": "example.com",
  //           "currency": "JCS",
  //           "token_name": "Jesus Christ Saves",
  //           "primary_region": { "lat": 32.7767, "lng": -96.7970, "label": "US · Dallas" },
  //           "reputationScore": 94,
  //           "riskTier": "trusted",
  //           "has_verified_domain": true,
  //           "has_xrpl_toml": true,
  //           "is_blackholed": true,
  //           "total_trustlines": 1234,
  //           "total_liquidity_usd": 123456.78,
  //           "flags": [],
  //           "tags": ["faith", "community"],
  //           "links": {
  //             "website": "https://jesuschristsavestoken.com",
  //             "explorer": "https://bithomp.com/explorer/rXXXXXXXX"
  //           }
  //         },
  //         {
  //           "issuer": "rSCAM",
  //           "domain": null,
  //           "currency": "SCAM",
  //           "token_name": "Scam Token",
  //           "primary_region": { "lat": 25.2, "lng": 55.3, "label": "Unknown region" },
  //           "reputationScore": 12,
  //           "riskTier": "risk",
  //           "has_verified_domain": false,
  //           "has_xrpl_toml": false,
  //           "is_blackholed": false,
  //           "total_trustlines": 2,
  //           "total_liquidity_usd": 0.01,
  //           "flags": ["no_liquidity", "no_metadata"],
  //           "tags": [],
  //           "links": { "explorer": "https://bithomp.com/explorer/rSCAM" }
  //         }
  //      ],
  //      "prayers": [
  //        {
  //          "lat": 40.71,
  //          "lng": -74.0,
  //          "short": "Praying for wisdom in this market.",
  //          "ledger_hash": "ABC...",
  //          "ts": "2025-11-08T12:00:00Z"
  //        }
  //      ]
  //    }
  //
  // Implement real logic server-side using xrpl.org APIs and your curated lists.

  const MAP_DEFAULT = {
    center: [20, 0],
    zoom: 2.2,
    minZoom: 2,
    maxZoom: 8
  };

  const LAYER_IDS = {
    LIQUIDITY: "liquidity",
    TRUSTED: "trusted",
    WATCH: "watch",
    RISK: "risk",
    PRAYERS: "prayers",
    AMM: "amm"
  };

  const RiskColors = {
    trusted: "#4ade80",
    watch: "#facc15",
    risk: "#f97373"
  };

  /* =========================
     STATE
     ========================= */

  const State = {
    map: null,
    dataLoaded: false,
    overview: null,
    layers: {
      [LAYER_IDS.LIQUIDITY]: null,
      [LAYER_IDS.TRUSTED]: null,
      [LAYER_IDS.WATCH]: null,
      [LAYER_IDS.RISK]: null,
      [LAYER_IDS.PRAYERS]: null,
      [LAYER_IDS.AMM]: null
    },
    filters: {
      [LAYER_IDS.LIQUIDITY]: true,
      [LAYER_IDS.TRUSTED]: true,
      [LAYER_IDS.WATCH]: true,
      [LAYER_IDS.RISK]: true,
      [LAYER_IDS.PRAYERS]: true,
      [LAYER_IDS.AMM]: true
    },
    selection: null
  };

  /* =========================
     UTIL
     ========================= */

  function short(text, len = 14) {
    if (!text) return "";
    return text.length > len ? text.slice(0, len) + "…" : text;
  }

  function fmtUSD(v) {
    if (v === null || v === undefined || isNaN(v)) return "—";
    if (v === 0) return "$0";
    if (v < 1) return "$" + v.toFixed(4);
    if (v < 1000) return "$" + v.toFixed(2);
    if (v < 1e6) return "$" + (v / 1e3).toFixed(1) + "k";
    if (v < 1e9) return "$" + (v / 1e6).toFixed(1) + "M";
    return "$" + (v / 1e9).toFixed(1) + "B";
  }

  function fmtInt(v) {
    if (v === null || v === undefined || isNaN(v)) return "—";
    return v.toLocaleString();
  }

  function riskTier(score) {
    if (score === null || score === undefined || isNaN(score)) return "risk";
    if (score >= 80) return "trusted";
    if (score >= 40) return "watch";
    return "risk";
  }

  function createToast(message, type = "info", timeoutMs = 2600) {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.dataset.type = type;
    toast.innerHTML = `<span class="dot"></span><span>${message}</span>`;
    container.appendChild(toast);

    // force reflow then show
    void toast.offsetWidth;
    toast.classList.add("show");

    setTimeout(() => {
      toast.classList.remove("show");
      setTimeout(() => toast.remove(), 260);
    }, timeoutMs);
  }

  function clearDetailPanel() {
    const title = document.getElementById("selection-title");
    const scroll = document.getElementById("detail-scroll");
    title.textContent = "Click a hotspot or token marker";
    scroll.innerHTML = `
      <div class="detail-block">
        <h3>How this map works</h3>
        <p>
          Click colored markers or circles to inspect regions, AMM pools,
          and tokens. Reputation scores are calculated on your backend
          so you can align them with your own standards.
        </p>
      </div>`;
  }

  function renderRiskPill(tier, score) {
    const v = document.createElement("span");
    v.className = `risk-pill ${tier}`;
    v.innerHTML = `<span></span>${tier.toUpperCase()} · ${score ?? "N/A"}/100`;
    return v;
  }

  /* =========================
     MAP INIT
     ========================= */

  function initMap() {
    const m = L.map("map", {
      zoomControl: true,
      minZoom: MAP_DEFAULT.minZoom,
      maxZoom: MAP_DEFAULT.maxZoom,
      worldCopyJump: true
    }).setView(MAP_DEFAULT.center, MAP_DEFAULT.zoom);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(m);

    State.map = m;
  }

  /* =========================
     LAYER BUILDERS
     ========================= */

  function buildLiquidityLayer(pools) {
    if (!State.map) return null;
    const group = L.layerGroup();

    pools.forEach(pool => {
      if (!pool.lat || !pool.lng) return;

      const intensity = typeof pool.heat === "number"
        ? Math.max(0.15, Math.min(pool.heat, 1))
        : Math.max(0.15, Math.min(pool.liquidity_usd / 500000, 1));

      const radius = 14 + intensity * 26;

      const circle = L.circleMarker([pool.lat, pool.lng], {
        radius,
        color: "rgba(56,189,248,0.85)",
        weight: 1,
        opacity: 0.9,
        fillColor: "rgba(56,189,248,0.22)",
        fillOpacity: 0.6
      });

      const listedPairs = (pool.token_pairs || [])
        .map(p => `${p.base}/${p.quote}`)
        .join(", ");

      const popupHTML = `
        <div style="font-size:10px;">
          <div><strong>Liquidity hotspot</strong></div>
          <div>${pool.region_label || "Region"} · AMM/DEX</div>
          <div>Liquidity: <strong>${fmtUSD(pool.liquidity_usd)}</strong></div>
          ${listedPairs ? `<div>Pairs: ${listedPairs}</div>` : ""}
          <div style="margin-top:3px;color:#9ca3af;">
            Click to inspect details in sidebar.
          </div>
        </div>
      `;

      circle.on("click", () => {
        showRegionDetail(pool);
      });

      circle.bindPopup(popupHTML, {
        className: "liquidity-popup",
        autoPan: true,
        maxWidth: 260
      });

      group.addLayer(circle);
    });

    return group;
  }

  function buildIssuerLayers(issuers) {
    const trusted = L.layerGroup();
    const watch = L.layerGroup();
    const risk = L.layerGroup();

    issuers.forEach(issuer => {
      const loc = issuer.primary_region;
      if (!loc || typeof loc.lat !== "number" || typeof loc.lng !== "number") return;

      const tier = issuer.riskTier || riskTier(issuer.reputationScore);
      const baseColor = RiskColors[tier] || RiskColors.risk;

      const icon = L.divIcon({
        className: "issuer-marker",
        html: `
          <div
            style="
              width:18px;height:18px;border-radius:999px;
              border:1px solid ${baseColor};
              background:rgba(0,0,0,0.96);
              display:flex;align-items:center;justify-content:center;
              box-shadow:0 0 10px ${baseColor}55;
              font-size:9px;color:${baseColor};
            "
          >✚</div>
        `,
        iconSize: [18, 18],
        iconAnchor: [9, 9]
      });

      const marker = L.marker([loc.lat, loc.lng], { icon });

      marker.on("click", () => {
        showIssuerDetail(issuer);
      });

      const popupHTML = `
        <div style="font-size:10px;">
          <div><strong>${issuer.token_name || issuer.currency || "Token"}</strong></div>
          <div>${issuer.currency || ""} · ${short(issuer.issuer)}</div>
          <div>Region: ${loc.label || "Unknown"}</div>
          <div>Score: ${issuer.reputationScore ?? "N/A"}</div>
          <div>Tier: ${tier.toUpperCase()}</div>
          <div style="margin-top:3px;color:#9ca3af;">Click to open full profile.</div>
        </div>
      `;

      marker.bindPopup(popupHTML, {
        className: "issuer-popup",
        autoPan: true,
        maxWidth: 260
      });

      if (tier === "trusted") trusted.addLayer(marker);
      else if (tier === "watch") watch.addLayer(marker);
      else risk.addLayer(marker);
    });

    return { trusted, watch, risk };
  }

  function buildPrayerLayer(prayers) {
    const group = L.layerGroup();
    if (!prayers) return group;

    prayers.forEach(p => {
      if (!p.lat || !p.lng) return;
      const marker = L.circleMarker([p.lat, p.lng], {
        radius: 3,
        color: "rgba(250,204,21,0.92)",
        weight: 1,
        fillColor: "rgba(250,204,21,0.8)",
        fillOpacity: 0.9
      });

      const popupHTML = `
        <div style="font-size:9px;">
          <div><strong>Prayer signal</strong></div>
          <div>${p.short || ""}</div>
          ${
            p.ledger_hash
              ? `<div style="margin-top:2px;"><a href="https://bithomp.com/explorer/${p.ledger_hash}" target="_blank" rel="noopener">View on XRPL</a></div>`
              : ""
          }
        </div>
      `;

      marker.bindPopup(popupHTML, {
        className: "prayer-popup",
        autoPan: true,
        maxWidth: 220
      });

      group.addLayer(marker);
    });

    return group;
  }

  /* =========================
     DETAIL RENDERERS
     ========================= */

  function showRegionDetail(pool) {
    State.selection = { type: "pool", data: pool };

    const title = document.getElementById("selection-title");
    const scroll = document.getElementById("detail-scroll");
    title.textContent = pool.region_label || "Liquidity region";

    const pairsHTML = (pool.token_pairs || [])
      .map(p => `<span>${p.base}/${p.quote}</span>`)
      .join(", ");

    scroll.innerHTML = "";

    const block = document.createElement("div");
    block.className = "detail-block";
    block.innerHTML = `
      <h3>Region overview</h3>
      <div class="detail-row">
        <div class="detail-label">Region</div>
        <div class="detail-value">${pool.region_label || "Unknown"}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Liquidity</div>
        <div class="detail-value">${fmtUSD(pool.liquidity_usd)}</div>
      </div>
      ${
        pairsHTML
          ? `<div class="detail-row">
               <div class="detail-label">Key pairs</div>
               <div class="detail-value">${pairsHTML}</div>
             </div>`
          : ""
      }
      <p style="margin-top:4px;color:#9ca3af;font-size:9px;">
        Liquidity scores are computed by your backend from AMM pools and DEX depth.
        Use this view to see where serious liquidity is concentrated.
      </p>
    `;

    scroll.appendChild(block);
  }

  function showIssuerDetail(issuer) {
    State.selection = { type: "issuer", data: issuer };

    const title = document.getElementById("selection-title");
    const scroll = document.getElementById("detail-scroll");
    const tier = issuer.riskTier || riskTier(issuer.reputationScore);

    title.textContent = issuer.token_name || issuer.currency || "Token issuer";

    scroll.innerHTML = "";

    const head = document.createElement("div");
    head.className = "detail-block";
    const pill = renderRiskPill(tier, issuer.reputationScore);
    head.innerHTML = `
      <h3>${issuer.token_name || issuer.currency || "Token"}</h3>
      <div class="detail-row">
        <div class="detail-label">Currency</div>
        <div class="detail-value">${issuer.currency || "N/A"}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Issuer</div>
        <div class="detail-value">${short(issuer.issuer, 22)}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Region</div>
        <div class="detail-value">${issuer.primary_region?.label || "Unknown"}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Trustlines</div>
        <div class="detail-value">${fmtInt(issuer.total_trustlines)}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Liquidity</div>
        <div class="detail-value">${fmtUSD(issuer.total_liquidity_usd)}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Domain verified</div>
        <div class="detail-value">${issuer.has_verified_domain ? "Yes" : "No"}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">xrp-ledger.toml</div>
        <div class="detail-value">${issuer.has_xrpl_toml ? "Yes" : "No"}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Blackholed</div>
        <div class="detail-value">${issuer.is_blackholed ? "Yes" : "No"}</div>
      </div>
    `;
    head.appendChild(pill);

    scroll.appendChild(head);

    const flags = issuer.flags || [];
    if (flags.length) {
      const f = document.createElement("div");
      f.className = "detail-block";
      f.innerHTML = `
        <h3>Flags / reasons</h3>
        <ul style="padding-left:12px;margin-top:3px;">
          ${flags.map(fl => `<li>${fl}</li>`).join("")}
        </ul>
      `;
      scroll.appendChild(f);
    }

    const tags = issuer.tags || [];
    if (tags.length) {
      const t = document.createElement("div");
      t.className = "detail-block";
      t.innerHTML = `
        <h3>Tags</h3>
        <div>${tags.map(tag => `<span class="risk-pill">${tag}</span>`).join(" ")}</div>
      `;
      scroll.appendChild(t);
    }

    const links = issuer.links || {};
    const linkBlock = document.createElement("div");
    linkBlock.className = "detail-block";
    linkBlock.innerHTML = `<h3>Links</h3>`;
    const linkList = [];

    if (links.website) {
      linkList.push(
        `<a href="${links.website}" target="_blank" rel="noopener">Website</a>`
      );
    }
    if (links.explorer) {
      linkList.push(
        `<a href="${links.explorer}" target="_blank" rel="noopener">Explorer</a>`
      );
    }
    if (links.sologenic) {
      linkList.push(
        `<a href="${links.sologenic}" target="_blank" rel="noopener">Sologenic</a>`
      );
    }
    if (links.xpmarket) {
      linkList.push(
        `<a href="${links.xpmarket}" target="_blank" rel="noopener">XPMarket</a>`
      );
    }

    linkBlock.innerHTML += `
      <div style="display:flex;flex-wrap:wrap;gap:6px;font-size:9px;margin-top:3px;">
        ${linkList.join("") || "No external links provided by backend."}
      </div>
      <p style="margin-top:4px;color:#9ca3af;font-size:8px;">
        Links are provided by your proxy based on issuer metadata and
        verification. Keep that list curated.
      </p>
    `;

    scroll.appendChild(linkBlock);
  }

  /* =========================
     FILTER HANDLING
     ========================= */

  function applyFilters() {
    const { layers, filters, map } = State;
    if (!map) return;

    Object.entries(layers).forEach(([key, layer]) => {
      if (!layer) return;
      if (filters[key]) {
        if (!map.hasLayer(layer)) map.addLayer(layer);
      } else {
        if (map.hasLayer(layer)) map.removeLayer(layer);
      }
    });
  }

  function initFilterUI() {
    const chips = document.querySelectorAll(".filter-chip");
    chips.forEach(chip => {
      const id = chip.dataset.filter;
      chip.addEventListener("click", () => {
        const current = chip.getAttribute("data-active") === "true";
        const next = !current;
        chip.setAttribute("data-active", String(next));
        State.filters[id] = next;
        applyFilters();
      });
    });
  }

  /* =========================
     DATA LOADING
     ========================= */

  async function fetchOverview() {
    const url = `${XRPL_PROXY_BASE}/api/map/overview`;
    const res = await fetch(url, {
      method: "GET",
      headers: { "Accept": "application/json" }
    });
    if (!res.ok) {
      throw new Error(`Proxy error: ${res.status}`);
    }
    return res.json();
  }

  async function loadDataAndRender() {
    try {
      createToast("Loading XRPL map metrics from your proxy…", "info", 2200);

      const overview = await fetchOverview();
      State.overview = overview;
      State.dataLoaded = true;

      // Stats
      const summary = overview.summary || {};
      document.getElementById("stat-tokens").textContent = fmtInt(summary.token_count);
      document.getElementById("stat-trusted").textContent = fmtInt(summary.trusted_count);
      document.getElementById("stat-risk").textContent =
        fmtInt((summary.watch_count || 0) + (summary.risk_count || 0));
      document.getElementById("stat-pools").textContent = fmtInt(summary.amm_pools);

      // Layers
      const pools = overview.pools || [];
      const issuers = overview.issuers || [];
      const prayers = overview.prayers || [];

      // Liquidity heat
      const liquidityLayer = buildLiquidityLayer(pools);
      if (liquidityLayer) {
        State.layers[LAYER_IDS.LIQUIDITY] = liquidityLayer;
        State.layers[LAYER_IDS.AMM] = liquidityLayer; // alias for toggle
      }

      // Issuer markers
      const issuerLayers = buildIssuerLayers(issuers);
      State.layers[LAYER_IDS.TRUSTED] = issuerLayers.trusted;
      State.layers[LAYER_IDS.WATCH] = issuerLayers.watch;
      State.layers[LAYER_IDS.RISK] = issuerLayers.risk;

      // Prayer markers
      State.layers[LAYER_IDS.PRAYERS] = buildPrayerLayer(prayers);

      // Add active layers to map
      Object.entries(State.layers).forEach(([id, layer]) => {
        if (!layer || !State.filters[id]) return;
        State.map.addLayer(layer);
      });

      createToast("Map metrics loaded from XRPL proxy.", "success", 2200);
    } catch (err) {
      console.error(err);
      createToast("Failed to load map metrics from proxy.", "error", 3600);
      clearDetailPanel();
    }
  }

  /* =========================
     PRAYER STRIP VERSES ROTATION
     ========================= */

  const verses = [
    `“I am the way, the truth, and the life.” — John 14:6`,
    `“Come unto me, all ye that labour and are heavy laden, and I will give you rest.” — Matthew 11:28`,
    `“Blessed are the peacemakers: for they shall be called the children of God.” — Matthew 5:9`,
    `“Let not your heart be troubled: ye believe in God, believe also in me.” — John 14:1`,
    `“Seek ye first the kingdom of God, and his righteousness.” — Matthew 6:33`
  ];

  function rotatePrayerStrip() {
    const el = document.getElementById("prayer-strip-text");
    if (!el) return;
    const idx = Math.floor(Date.now() / (1000 * 60)) % verses.length;
    el.textContent = verses[idx];
  }

  /* =========================
     INIT
     ========================= */

  document.addEventListener("DOMContentLoaded", () => {
    initMap();
    initFilterUI();
    clearDetailPanel();
    rotatePrayerStrip();
    setInterval(rotatePrayerStrip, 45000);

    // Kick data load
    loadDataAndRender();
  });
</script>
</body>
</html>

