<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Prayer Map – Connected to XRP Ledger</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    html, body, #container {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: #0e1822;
      overflow: hidden;
    }
    #container {
      position: relative;
      height: 100vh;
      width: 100vw;
      /* Change the image URL below to your background image */
      background: url('YOUR_BACKGROUND_IMAGE_URL.jpg') center center / cover no-repeat;
      overflow: hidden;
    }
    #map {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #prayer-form-container {
      position: absolute;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 900;
      background: rgba(255,255,255,0.95);
      border-radius: 18px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.15);
      padding: 20px 28px 16px 28px;
      min-width: 280px;
      max-width: 95vw;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    @media (max-width: 600px) {
      #prayer-form-container {
        min-width: unset;
        max-width: 99vw;
        padding: 12px 6vw 10px 6vw;
      }
    }
    #prayer-form label {
      font-size: 1.07em;
      color: #384056;
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }
    #prayer-form textarea {
      width: 100%;
      min-height: 68px;
      border-radius: 7px;
      padding: 8px 10px;
      border: 1px solid #bdbecb;
      margin-bottom: 12px;
      font-size: 1em;
      resize: vertical;
      background: #f9faff;
      color: #384056;
      font-family: inherit;
    }
    #prayer-form button {
      background: #2461b1;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 28px;
      font-size: 1.0em;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 8px 0 rgba(36,97,177,0.17);
      transition: background .18s;
    }
    #prayer-form button:disabled {
      background: #b5c8e6;
      cursor: not-allowed;
    }
    /* Leaflet popups: make them larger and more readable */
    .leaflet-popup-content-wrapper {
      background: #f6f8fc;
      border-radius: 13px;
      box-shadow: 0 2px 16px rgba(63,79,117,0.08);
    }
    .leaflet-popup-content {
      color: #223156;
      font-size: 1.1em;
      font-weight: 500;
      line-height: 1.35;
      padding: 8px 8px 6px 8px;
    }
    /* Hide the Leaflet logo/attribution */
    /* This is also handled in JS, but double-guard with CSS */
    .leaflet-control-attribution,
    .leaflet-control-container .leaflet-control-attribution {
      display: none !important;
      visibility: hidden;
    }
    /* Custom feedback popup styling */
    #popup-feedback {
      position: absolute;
      left: 50%;
      top: 18%;
      z-index: 1100;
      transform: translateX(-50%);
      background: #ffffffdd;
      border-radius: 18px;
      box-shadow: 0 6px 32px rgba(43,77,172,0.30);
      padding: 32px 40px;
      font-size: 1.3em;
      font-weight: 600;
      text-align: center;
      color: #278419;
      animation: popupIn 0.35s cubic-bezier(.4,1.3,.8,1);
      display: none;
    }
    @keyframes popupIn {
      from { opacity: 0; transform: translateX(-50%) scale(.85);}
      to   { opacity: 1; transform: translateX(-50%) scale(1);}
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="map"></div>

    <div id="prayer-form-container">
      <form id="prayer-form" autocomplete="off">
        <label for="prayer-text">Add your prayer to the map (recorded on the XRP Ledger):</label>
        <textarea id="prayer-text" name="prayer-text" maxlength="350" required placeholder="Type your prayer or blessing here (max 350 characters)..."></textarea>
        <button id="submit-prayer" type="submit">Submit Prayer</button>
      </form>
    </div>

    <div id="popup-feedback"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- xrpl.js for browser -->
  <script src="https://unpkg.com/xrpl/build/xrpl-latest-min.js"></script>

  <script>
    /***********************
     * LEAFLET MAP SETUP
     ***********************/
    let map;
    let lastClickLatLng = null; // Store for optional future use
    document.addEventListener("DOMContentLoaded", function () {
      // Ensure any prior attribution controls are not rendered
      let defaultCoords = [20.0, 0.0]; // Center map on world
      let defaultZoom = 2;

      map = L.map("map", {
        attributionControl: false,
        zoomControl: true,
        minZoom: 2,
        maxZoom: 10,
        // If "closePopupOnClick: false" is desired for multiple confirmations, add the flag
      }).setView(defaultCoords, defaultZoom);

      // OpenStreetMap tiles (no attribution control as per requirements; check OSM terms for production)
      const tiles = L.tileLayer(
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { 
          maxZoom: 19,
          crossOrigin: true,
          errorTileUrl: '', // Transparent on error, or use a branded placeholder
          attribution: ''   // Ensure no attribution string is injected
        }
      ).addTo(map);

      // Robust tile error handler (optional log or feedback)
      tiles.on('tileerror', function (e) {
        // Could display a user message or replace tile with custom error image here
        // For now: silent
      });

      // Prevent all attribution controls even if added via a rogue tileLayer or plugin
      let attrEls = document.querySelectorAll('.leaflet-control-attribution');
      attrEls.forEach(el => el.style.display = 'none');

      // Click on map: optionally allow user to place marker/prayer at custom location.
      map.on('click', function (e) {
        lastClickLatLng = e.latlng;
        document.getElementById('prayer-text').focus();
      });
    });

    /**************************************
     * XRP LEDGER INTEGRATION & SUBMISSION
     **************************************/
    // Demo: use an ephemeral, testnet-funded account for write operations
    // For production, replace with user-managed wallet or Oauth-style wallet connector.
    let xrplClient = null;
    let xrplWallet = null;
    let ledgerReady = false;

    // Helper: Create popup feedback (not to be confused with Leaflet's popup-on-map)
    function showFeedbackPopup(message, isError = false) {
      const feedback = document.getElementById('popup-feedback');
      feedback.innerText = message;
      feedback.style.color = isError ? '#db3030' : '#278419';
      feedback.style.display = 'block';
      setTimeout(() => { feedback.style.display = 'none'; }, isError ? 4000 : 2750);
    }

    // Helper: Map Leaflet popup at last clicked spot, or at random on world
    function showMapPopup(message, latlng=null) {
      let coord = latlng || lastClickLatLng || [19.0 - Math.random()*30 + 15.0, Math.random()*130 - 65];
      map.openPopup(message, coord, {autoClose: true, closeOnClick: false});
    }

    // Preload: Connect to XRP Ledger testnet, fund a demo wallet (for browser demo only)
    // For real use, prompt user to provide a wallet or connect their own!
    async function xrplInit() {
      if (ledgerReady) return true;
      try {
        xrplClient = new xrpl.Client('wss://s.altnet.rippletest.net:51233');
        await xrplClient.connect();
        // Use faucet to create/fund an ephemeral wallet for this session
        const resp = await xrplClient.fundWallet(); // faucet call
        xrplWallet = resp.wallet;
        ledgerReady = true;
        return true;
      } catch (e) {
        showFeedbackPopup('Error initializing XRP connection. Try reloading.', true);
        return false;
      }
    }

    // Prayer form event handler
    document.addEventListener('DOMContentLoaded', function () {
      const prayerForm = document.getElementById('prayer-form');
      const prayerTextArea = document.getElementById('prayer-text');
      const submitBtn = document.getElementById('submit-prayer');
      let submitting = false;

      prayerForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        if (submitting) return;
        const text = prayerTextArea.value.trim();
        if (!text) {
          prayerTextArea.focus();
          return;
        }
        submitting = true;
        submitBtn.disabled = true;
        submitBtn.innerText = "Submitting...";

        // Initialize XRPL if not yet ready
        let ok = await xrplInit();
        if (!ok) {
          // Already notified error
          submitting = false;
          submitBtn.disabled = false;
          submitBtn.innerText = "Submit Prayer";
          return;
        }

        // Compose a "marker" transaction on the XRPL Testnet
        // Use a tiny Payment (to self) and memo record of prayer
        // Min amount as spam prevention
        try {
          const Wallet = xrplWallet;
          const MemoString = text.slice(0,350);
          const tx = {
            TransactionType: "Payment",
            Account: Wallet.address,
            Amount: xrpl.xrpToDrops('0.000001'), // 1 drop
            Destination: Wallet.address, // For demo, send to self for privacy; for public map, use a central collector
            Memos: [
              {
                Memo: {
                  MemoType: xrpl.convertStringToHex('Prayer'),
                  MemoData: xrpl.convertStringToHex(MemoString)
                }
              }
            ]
          };
          // Autofill Fee, Sequence, LastLedgerSequence
          const prepared = await xrplClient.autofill(tx);

          // Sign locally
          const signed = Wallet.sign(prepared);

          // Submit and wait for inclusion+validation
          const result = await xrplClient.submitAndWait(signed.tx_blob);
          submitting = false;
          submitBtn.disabled = false;
          submitBtn.innerText = "Submit Prayer";
          prayerTextArea.value = '';
          // Handle final ledger result
          if (result.result && result.result.meta && result.result.meta.TransactionResult === "tesSUCCESS") {
            // Success: show map popup at last click (or, for demo, at random)
            showMapPopup("🙏 Your prayer has been recorded on the XRP Ledger.", lastClickLatLng);
            showFeedbackPopup("Prayer submitted successfully!");
          } else {
            let msg = "Submission failed: " + 
              ((result.result && result.result.engine_result_message) ? result.result.engine_result_message : "Unknown error");
            showFeedbackPopup(msg, true);
          }
        } catch (err) {
          submitting = false;
          submitBtn.disabled = false;
          submitBtn.innerText = "Submit Prayer";
          showFeedbackPopup("Network/ledger error. Try again.", true);
        }
      });
    });

    // Defensive: Remove any attributions or unwanted footers, after any delay (double guard)
    setInterval(() => {
      let attrEls = document.querySelectorAll('.leaflet-control-attribution');
      attrEls.forEach(el => el.style.display = 'none');
      // Remove any rogue footers or design credits (there should be none, per full audit)
      let rogueFooter = document.querySelector('footer');
      if (rogueFooter) rogueFooter.parentNode.removeChild(rogueFooter);
    }, 2000);

  </script>
</body>
</html>

