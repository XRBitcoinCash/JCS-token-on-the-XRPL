<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Prayer Map – Live Prayers on the XRP Ledger</title>
  <!-- Responsive viewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-tA3U+IdS/Cdj8w7Su4vZZqiq99O/ZMbxzSUzV4F3FhU="
    crossorigin=""
  />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      background: #fff; /* base color */
      /* Multi-layer backgrounds: main celestial theme */
      background:
        /* Layer 1: Radial gradient for central glow */
        radial-gradient(ellipse at 60% 30%, rgba(220,230,255,0.45) 0%, rgba(255,255,255,0.0) 70%),
        /* Layer 2: Large linear gradient for aurora effect */
        linear-gradient(135deg, #e7e9fb 0%, #d5f6ff 100%),
        /* Layer 3: Subtle blue-violet */
        linear-gradient(100deg, #f2f7fd 0%, #e8eeff 100%);
      animation: body-fadein 1.25s ease;
      overflow: hidden;
    }
    @keyframes body-fadein {
      from { opacity: 0;}
      to   { opacity: 1;}
    }

    /* Cloud overlay (absolutely positioned) */
    .clouds-bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
      background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1280&q=80') repeat-x;
      background-size: cover;
      opacity: 0.18;
      animation: clouds-move 60s linear infinite;
      will-change: background-position;
    }
    @keyframes clouds-move {
      0% { background-position-x: 0; }
      100% { background-position-x: -600px; }
    }

    /* Gradient masks for left/right fadeout */
    .gradient-mask {
      position: absolute;
      left: 0; top: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: 10;
      background: linear-gradient(90deg,
        #fff 0%, rgba(255,255,255,0.98) 3%, rgba(255,255,255,0) 10%,
        rgba(255,255,255,0) 90%, rgba(255,255,255,0.98) 97%, #fff 100%);
      user-select: none;
    }

    /* Map container: horizontal scroll, locked vertically */
    .scroll-horiz {
      position: relative;
      width: 100vw;
      height: 355px;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      scroll-snap-type: x mandatory;
      background: transparent;
      margin-top: 3.5em;
      margin-bottom: 2em;
      border-radius: 32px;
      box-shadow: 0 4px 18px 0 rgba(180, 190, 255, 0.14);
      z-index: 2;
    }
    .map-wrapper {
      position: relative;
      width: 2024px; /* Large space to enable horizontal scroll */
      max-width: 2400px;
      height: 100%;
      margin: 0 auto;
      scroll-snap-align: start;
      background: transparent;
    }

    /* Map itself uses entire wrapper */
    #map {
      width: 100%;
      height: 100%;
      border-radius: 32px;
      z-index: 3;
    }

    /* Custom marker icon: glowing celestial theme */
    .custom-marker {
      width: 36px;
      height: 36px;
      background: radial-gradient(circle at 60% 40%, #eef6ff 0%, #b5d0ff 60%, rgba(36,73,170,0.09) 100%);
      border-radius: 50%;
      box-shadow: 0 0 16px 2px rgba(50,116,255,0.25), 0 0 32px 14px rgba(255,255,255,0.08);
      border: 2.5px solid #e9eaff;
      transition: transform 0.22s cubic-bezier(0.36,1, 0.68,1.17), box-shadow 0.18s;
      will-change: transform, box-shadow;
      cursor: pointer;
      opacity: 0;
      transform: scale(0.6) translateY(18px);
      /* Fade-in-up */
      animation: marker-fadein-up 0.9s cubic-bezier(0.36,1,0.68,1.17) forwards;
    }
    .custom-marker-glow {
      box-shadow: 0 0 38px 8px #c4e8fd99, 0 0 12px 3px #81addd44, 0 0 6px 4px #b3beff22;
      border-color: #fffbe7;
      background: radial-gradient(circle at 60% 40%, #fbf9ff 0%, #f9e6ff 60%, #b5d0ff 100%);
    }
    @keyframes marker-fadein-up {
      0%   { opacity: 0;   transform: scale(0.6) translateY(24px);}
      50%  { opacity: 1;   transform: scale(1.1) translateY(-6px);}
      85%  {               transform: scale(0.98) translateY(0);}
      100% { opacity: 1;   transform: scale(1.0) translateY(0);}
    }
    .custom-marker:hover, .custom-marker:focus {
      transform: scale(1.08) translateY(-3px);
      box-shadow: 0 0 24px 8px #d1e4ef99, 0 0 6px 2px #c0c5dd44, 0 0 12px 6px #fadfed22;
    }

    /* Leaflet Popup Styling */
    .leaflet-popup-content-wrapper {
      background: #fffffffa;
      border-radius: 19px;
      box-shadow: 0 6px 20px 0 rgba(185,196,245,0.16), 0 2px 14px 0 rgba(218, 232, 255, 0.10);
      border: 1.7px solid #e8f0fa;
      padding: 0.7em;
      animation: popup-fadein 0.5s;
    }
    .leaflet-popup-content {
      color: #2d347d;
      font-family: 'Quicksand', 'Arial Rounded MT Bold', Arial, sans-serif;
      font-size: 1.12em;
      font-weight: 500;
      line-height: 1.65;
      padding: 0.23em 0.6em;
      background: transparent;
    }
    @keyframes popup-fadein {
      from { opacity: 0; transform: scale(0.7);}
      to   { opacity: 1; transform: scale(1);}
    }
    .leaflet-popup-tip {
      background: #f6f8ff !important;
    }
    .leaflet-marker-icon {
      border: none !important;
      background: transparent !important;
    }
    .leaflet-container {
      background: transparent;
      font-family: inherit;
      user-select: none;
      touch-action: pan-x;
    }
    .leaflet-bar, .leaflet-control-attribution {
      display: none !important;
    }
    /* Remove vertical map drag/zoom if vertical-locked */
    .map-vertical-locked .leaflet-container {
      pointer-events: initial;
      touch-action: pan-x;
    }
    /* Accessibility: focus outline for marker popups */
    .leaflet-marker-icon:focus-visible {
      outline: 2.5px solid #e7ceff;
      outline-offset: 3px;
    }
    /* Scrollbar styling */
    .scroll-horiz::-webkit-scrollbar {
      height: 13px;
      background: rgba(255,255,255,0.16);
      border-radius: 7px;
    }
    .scroll-horiz::-webkit-scrollbar-thumb {
      background: linear-gradient(90deg, #e6e7fd 35%, #e7f7fd 65%);
      border-radius: 7px;
    }
    /* Fade-in animation for top header and info */
    .fade-in {
      opacity: 0;
      animation: fadeInText 0.95s 0.15s cubic-bezier(0.24,0.97,0.62,1.005) forwards;
    }
    @keyframes fadeInText {
      from { opacity: 0; transform: translateY(9px);}
      to   { opacity: 1; transform: translateY(0);}
    }

    /* Responsive adjustments */
    @media (max-width: 900px) {
      .map-wrapper { width: 1200px; }
      .scroll-horiz { height: 260px;}
    }
    @media (max-width: 650px) {
      .map-wrapper { width: 940px;}
      .scroll-horiz { height: 210px;}
    }
    @media (max-width: 550px) {
      .map-wrapper { width: 700px;}
      .scroll-horiz { height: 170px;}
    }

    /* Attribution and info bar styles */
    .info-bar {
      padding: 1em 0.2em 0.7em 0.2em;
      text-align: center;
      font-size: 1em;
      color: #8BA0B6;
      background: transparent;
      font-family: 'Arial Rounded MT Bold', Arial, sans-serif;
      user-select: none;
    }

    /* Visually hidden for accessibility */
    .visually-hidden {
      position: absolute;
      left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden;
    }
  </style>
</head>
<body>
  <div class="clouds-bg"></div>
  <header style="text-align:center; padding-top:1.3em; z-index:12; position:relative;">
    <h1 class="fade-in" style="font-family:'Avenir Next', 'Arial Rounded MT Bold', Arial, sans-serif; color:#283a85; font-weight:800; font-size:2.02em; letter-spacing:0.01em; text-shadow:0 3px 12px #c6daefab, 0 0 10px #f6f8ff66;">
      <span style="vertical-align: -6px; font-size:1.10em;">☁️</span>
      Prayer Map: Live Prayers on the XRP Ledger
      <span style="vertical-align: -6px; font-size:1.10em;">☁️</span>
    </h1>
    <div class="fade-in" style="margin: 0.6em 0 0.25em 0; font-size:1.05em; color: #6089a6; font-family: Quicksand, sans-serif;">
      <span style="background:rgba(255,255,255,0.68); padding:0.11em 0.7em; border-radius:16px;"> Every prayer is a light. Click on a glowing marker to read a new prayer. </span>
    </div>
  </header>
  <!-- Horizontal scroll container for the map -->
  <div class="scroll-horiz" aria-label="Horizontally scrolling prayer map. Use left/right arrows or swipe to move." tabindex="0">
    <div class="gradient-mask"></div>
    <div class="map-wrapper">
      <div id="map" class="map-vertical-locked"></div>
    </div>
  </div>
  <div class="info-bar fade-in">
    <span>Powered by <a href="https://xrpl.org" target="_blank" style="color:#7d93c6;">XRP Ledger</a> and <a href="https://leafletjs.com/" target="_blank" style="color:#68a9f1;">Leaflet.js</a>.
      <span style="font-size:0.95em">Design: <a href="#" style="color:#b7a5f6;">Celestial theme</a> | <a href="#" style="color:#d3d6fe;">Cloud textures: Unsplash/Freepik</a></span>
    </span>
  </div>
  <!-- Visually hidden live region for ARIA updates -->
  <div class="visually-hidden" aria-live="polite" id="liveUpdate"></div>
  <!-- LEAFLET and XRPL -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-L8V0q6yMa/cjDg4xHvPX5r2fOv7rQ2/RjgeRweL3B1c="
    crossorigin=""
  ></script>
  <script src="https://unpkg.com/xrpl@2.13.1/dist/xrpl-latest-min.js"></script>

  <script>
    // --- Configuration ---
    const XRP_WS_ENDPOINT = "wss://xrplcluster.com/"; // For mainnet; alt: testnet endpoint
    //const XRP_WS_ENDPOINT = "wss://s.altnet.rippletest.net:51233"; // Testnet
    // Transaction Memo Filter
    const PRAYER_MEMO_TYPE = "Prayer";
    // Map initialization
    const MAP_INIT_CENTER = [24.5, 5]; // Somewhere over Mediterranean
    const MAP_INIT_ZOOM = 2;

    // Keeping a list of existing markers, markerId -> L.Marker
    const markers = new Map();
    // Prayer list in memory (for fitBounds and ARIA updates)
    const prayerTxList = [];
    // For ARIA live updates
    function announce(msg) {
      document.getElementById('liveUpdate').textContent = msg;
    }

    // --- Utility: Unicode and Memo decoding ---
    function hexToUtf8(hex) {
      if (!hex) return "";
      try { return decodeURIComponent(hex.replace(/\s+/g, '').replace(/[0-9a-f]{2}/g, '%$&')); }
      catch { return ""; }
    }

    // --- Main Map Setup ---
    let map, markersGroup;
    let autoFitted = false;
    function createMap() {
      map = L.map('map', {
        center: MAP_INIT_CENTER,
        zoom: MAP_INIT_ZOOM,
        zoomControl: false,
        attributionControl: false,
        dragging: true,
        doubleClickZoom: false,
        boxZoom: false,
        maxBoundsViscosity: 0.6, // locks panning at edge
      });
      // Theme: use "light" tile set for celestial look
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        minZoom: 2,
        maxZoom: 9,
        attribution: '',
      }).addTo(map);

      markersGroup = L.featureGroup().addTo(map);

      // Disable map drag vertically for vertical lock (pan-x only)
      let lastY = null;
      map.on('mousedown', function (e) { lastY = e.originalEvent.clientY; })
      map.on('drag', function (e) {
        let { clientY } = e.originalEvent || {};
        if (lastY !== null && Math.abs(clientY - lastY) > 16) {
          // Prevent vertical drag
          map.panBy([0, 0]);
        }
        lastY = clientY;
      });

      // Accessibility: Keyboard scroll for container
      const scrollEl = document.querySelector('.scroll-horiz');
      scrollEl.addEventListener('keydown', e => {
        if (e.key === "ArrowRight") { scrollEl.scrollLeft += 60; }
        if (e.key === "ArrowLeft") { scrollEl.scrollLeft -= 60; }
      });
    }

    // --- Custom Celestial Marker Icon ---
    function celestialIcon() {
      return L.divIcon({
        className: 'custom-marker',
        iconAnchor: [18, 18],
        iconSize: [36, 36],
        popupAnchor: [0, -10],
      });
    }

    function renderPrayerMarker(prayer) {
      // Compose message
      const content = `<div>
        <div style="font-weight:600;font-size:1.11em;margin-bottom:0.2em; color:#6d53b9;">
          <span>🙏</span> New Prayer Heard
        </div>
        <div style="font-size:1.08em;padding:0.11em 0.09em 0.14em 0.09em;">
          "${prayer.text || "(unintelligible)"}"
        </div>
        <div style="font-size:0.92em; color:#8e95bd; margin-top:0.34em;">
          <span>Tx:</span> <span style="word-break:break-all;">${prayer.id.substr(0,10)}...</span>
          <span style="float:right;">${prayer.time ? new Date(prayer.time*1000).toLocaleString() : ""}</span>
        </div>
      </div>`;

      // Already exists?
      if (markers.has(prayer.id)) return;
      // Default coordinates: random(20,160), or attach geo if available
      let coords = [prayer.lat, prayer.lng];
      if (typeof coords[0] !== "number") {
        // Random location for testing/demo only!
        const lat = 24 + Math.random() * 70 * (Math.random()>0.5?1:-1);
        const lng = 55 + Math.random() * 280 * (Math.random()>0.5?1:-1);
        coords = [lat, lng];
      }

      const marker = L.marker(coords, {
        icon: celestialIcon(),
        keyboard: true,
        autoPan: true,
        title: "Prayer Marker: " + (prayer.text ? prayer.text.slice(0,30) : "prayer"),
        alt: "Prayer marker",
      })
      .bindPopup(content, { maxWidth: 310, closeButton: true, closeOnClick: true });

      marker.on('popupopen', () => {
        setTimeout(() => {
          const popup = document.querySelector('.leaflet-popup');
          if (popup) popup.focus();
        }, 30);
      });

      marker.addTo(markersGroup);

      // Animate: add "custom-marker-glow" after delay
      setTimeout(() => {
        let iconDiv = marker._icon;
        if (iconDiv) iconDiv.classList.add("custom-marker-glow");
      }, 700 + 350 * Math.random());

      markers.set(prayer.id, marker);
      prayerTxList.push(marker);

      // Auto-fit on first or major update
      if (prayerTxList.length === 1 || !autoFitted) {
        setTimeout(() => fitMapToMarkers(), 320);
        autoFitted = true;
      } else if (prayerTxList.length > 1 && map) {
        // Optionally pan to new marker
        map.panTo(coords, { animate: true, duration: 0.87, easeLinearity: 0.22 });
      }

      // ARIA update
      announce(`Prayer received: ${prayer.text?.slice(0,70) || "unintelligible"}`);
    }

    function fitMapToMarkers() {
      if (!prayerTxList.length) return;
      try {
        const group = new L.featureGroup(prayerTxList);
        map.fitBounds(group.getBounds(), { padding: [33, 40], maxZoom: 5 });
      } catch {}
    }

    // --- XRPL WebSocket Real-Time Subscription ---
    let xrplClient;
    let reconnectTimeout = 3500; // ms
    let autoReconnectAttempts = 0;
    function connectXRPL() {
      if (xrplClient && xrplClient.isConnected) {
        xrplClient.disconnect();
      }
      xrplClient = new xrpl.Client(XRP_WS_ENDPOINT);
      xrplClient.connect().then(() => {
        xrplClient.request({
          command: "subscribe",
          streams: ["transactions"],
          // filter further later
        });
        xrplClient.on('transaction', handleTransaction);
      }).catch(e => {
        // Retry w/ limited exponential backoff up to 25s
        autoReconnectAttempts++;
        setTimeout(connectXRPL, Math.min(reconnectTimeout*(1+Math.random()), 25000));
      });

      // Graceful disconnect on page unload
      window.addEventListener('beforeunload', () => {
        try { if (xrplClient && xrplClient.isConnected) xrplClient.disconnect(); } catch { }
      });
    }

    function handleTransaction(evt) {
      let tx = evt.transaction;
      if (!tx || !evt.validated) return; // validated only
      if (!tx.Memos) return;
      let memo = null;
      for (let m of tx.Memos) {
        if (m.Memo && hexToUtf8(m.Memo.MemoType) === PRAYER_MEMO_TYPE) {
          memo = m.Memo;
          break;
        }
      }
      if (!memo) return;
      // Parse prayer payload
      let content = hexToUtf8(memo.MemoData || "");
      let lat = undefined, lng = undefined;
      // If prayer string contains coordinates, parse (e.g., JSON payload)
      try {
        if (content.startsWith('{') && content.endsWith('}')) {
          const obj = JSON.parse(content);
          content = obj.prayer || obj.text || content;
          lat = obj.lat || undefined;
          lng = obj.lng || undefined;
        }
      } catch {}
      // Transaction time: from ledger time if available
      const time = evt.metadata?.DeliveredAmount
                  ? tx.date || evt.ledger_time : undefined;
      renderPrayerMarker({
        id: tx.hash,
        text: content,
        time,
        lat, lng
      });
    }

    // --- Demo: Add mock prayers for demo/testing if no live events come in ---
    // Remove/comment for production
    function injectMockPrayers() {
      const samples = [
        "May peace and healing surround all who seek comfort.",
        "For courage as I face uncertain days ahead.",
        "Gratitude for friends who support me in faith.",
        "Prayer for guidance and wisdom in this new job.",
        "Remembering loved ones lost, may they find rest.",
        "Blessings for my family and those in need.",
        "Help me forgive as I have been forgiven.",
        "Strength to choose hope over fear.",
        "Love and unity for our divided world.",
        "Thank you for answered prayers and daily grace."
      ];
      for (let i = 0; i < samples.length; ++i) {
        setTimeout(() => {
          renderPrayerMarker({
            id: 'mock'+i+Date.now(),
            text: samples[i],
            time: Date.now()/1000 - 2000 + i*100,
            lat: null, lng: null
          });
        }, 500 + i*840);
      }
    }

    // --- Initialize everything on DOMContentLoaded ---
    document.addEventListener('DOMContentLoaded', function () {
      createMap();
      setTimeout(() => {
        // XRPL connection (uncomment for production)
        connectXRPL();
        // For demo purposes only
        setTimeout(injectMockPrayers, 2500);
      }, 950);
    });
  </script>
</body>
</html>
