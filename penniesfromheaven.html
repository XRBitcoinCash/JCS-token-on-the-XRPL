<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buy JCS Tokens ‚Äî XRPL dApp</title>
  <link rel="stylesheet" href="css/styles.css">

  <!-- XRPL + Xumm SDK -->
  <script src="https://unpkg.com/xrpl@2.7.0/build/xrpl-latest-min.js"></script>
  <script src="https://xumm.app/assets/cdn/xumm.min.js"></script>
</head>

<body>
  <header>
    <h1>JCS Token Buyer</h1>
    <button id="connectWalletBtn" class="btn">üîó Connect Wallet</button>
  </header>

  <main>
    <p id="walletStatus">Wallet not connected.</p>

    <section>
      <h2>Buy JCS Tokens</h2>
      <p>Step 1: Add trustline, Step 2: Buy tokens.</p>
      <button id="trustlineBtn" class="btn">‚ûï Add JCS Trustline</button>
      <button id="buyBtn" class="btn" disabled>üí∏ Buy JCS Tokens (1 XRP)</button>
    </section>

    <div id="qrBox" style="margin-top:20px;"></div>
    <div id="statusBox" style="margin-top:12px; background:#eee; padding:10px; border-radius:8px;"></div>
  </main>

  <footer>
    <p>&copy; 2025 Jesus Christ Saves Token</p>
  </footer>

  <script>
    const NETWORK_WSS = "wss://xrplcluster.com"; // XRPL Mainnet
    const ISSUER = "rPU6sXCNzsjcTUEmgJQ5SxDUzY2y1RyYKd"; // ‚úÖ JCS Issuer
    const CURRENCY = "JCS"; // ‚úÖ Token code
    const XUMM_API_KEY = "7737775c-1645-4a4e-a92d-ffe51530a348"; // ‚úÖ Your Xumm API key

    let xumm, xummConnected = false, xummAddress = null;

    const el = (id) => document.getElementById(id);
    const strToHex = (s = "") => Array.from(new TextEncoder().encode(s)).map(b => b.toString(16).padStart(2, "0")).join("");

    function setStatus(msg, type = "info") {
      const box = el("statusBox");
      box.style.color = (type === "error" ? "red" : type === "success" ? "green" : "black");
      box.innerText = msg;
    }

    const isMobile = () => /Mobi|Android/i.test(navigator.userAgent);

    async function waitForResult(uuid) {
      for (let i = 0; i < 120; i++) {
        const res = await xumm.payload.get(uuid);
        if (res?.response?.account) return res.response.account;
        if (res?.meta?.resolved) return res?.response?.txid || null;
        await new Promise(r => setTimeout(r, 1500));
      }
      return null;
    }

    async function connectWallet() {
      try {
        if (!xumm) xumm = new Xumm(XUMM_API_KEY);
        const payload = await xumm.payload.create({ txjson: { TransactionType: "SignIn" } });

        if (isMobile()) {
          window.location.href = payload.next.always;
        } else {
          el("qrBox").innerHTML = `<img src="${payload.refs.qr_png}" alt="Scan with Xumm" style="max-width:240px;">`;
        }

        const acct = await waitForResult(payload.uuid);
        if (!acct) return setStatus("‚ùå Wallet connect failed", "error");

        xummConnected = true;
        xummAddress = acct;
        el("walletStatus").innerText = `‚úÖ Connected: ${acct}`;
        el("buyBtn").disabled = false;
        setStatus("Wallet connected successfully.", "success");
      } catch (e) {
        setStatus(`‚ùå Connect error: ${e.message}`, "error");
      }
    }

    async function addTrustline() {
      if (!xummConnected) return setStatus("Connect wallet first.", "error");

      const txjson = {
        TransactionType: "TrustSet",
        LimitAmount: {
          currency: CURRENCY,
          issuer: ISSUER,
          value: "1000000000" // Max trust
        }
      };

      try {
        setStatus("Requesting trustline approval in Xumm‚Ä¶");
        const payload = await xumm.payload.create({ txjson });

        if (isMobile()) {
          window.location.href = payload.next.always;
        } else {
          el("qrBox").innerHTML = `<img src="${payload.refs.qr_png}" style="max-width:240px;">`;
        }

        const hash = await waitForResult(payload.uuid);
        if (!hash) throw new Error("Trustline not approved.");
        setStatus(`‚úÖ Trustline set! View TX: https://bithomp.com/explorer/${hash}`, "success");
      } catch (e) {
        setStatus(`‚ùå Trustline failed: ${e.message}`, "error");
      }
    }

    async function buyJCS() {
      if (!xummConnected) return setStatus("Connect wallet first.", "error");

      const txjson = {
        TransactionType: "Payment",
        Destination: ISSUER,
        Amount: xrpl.xrpToDrops("1"), // ‚úÖ 1 XRP
        Memos: [{ Memo: { MemoType: strToHex("purchase"), MemoData: strToHex("JCS_BUY") } }]
      };

      try {
        setStatus("Please approve the JCS purchase in Xumm‚Ä¶");
        const payload = await xumm.payload.create({ txjson });

        if (isMobile()) {
          window.location.href = payload.next.always;
        } else {
          el("qrBox").innerHTML = `<img src="${payload.refs.qr_png}" style="max-width:240px;">`;
        }

        const hash = await waitForResult(payload.uuid);
        if (!hash) throw new Error("Purchase not approved.");
        setStatus(`‚úÖ Purchase complete! View TX: https://bithomp.com/explorer/${hash}`, "success");
      } catch (e) {
        setStatus(`‚ùå Purchase failed: ${e.message}`, "error");
      }
    }

    el("connectWalletBtn").addEventListener("click", connectWallet);
    el("trustlineBtn").addEventListener("click", addTrustline);
    el("buyBtn").addEventListener("click", buyJCS);
  </script>
</body>
</html>

