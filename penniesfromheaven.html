<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pennies From Heaven | XRPL Prayer dApp</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <!-- N7: App Framework + Global CSS/JS -->
  <style>
    html, body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f6fafc;}
    .container { max-width: 520px; margin: 2em auto; padding: 1.5em; background: #fff; border-radius: 14px; box-shadow: 0 3px 16px #0002; }
    h1 { font-size: 2em; margin: 0 0 0.5em 0; }
    button, .btn { background: #255de6; color: #fff; border: none; border-radius: 6px; padding: 0.7em 1.5em; font-size: 1em; cursor: pointer; transition: background 0.1s; }
    button:disabled { background: #b0caf5; cursor: not-allowed;}
    .label { font-weight: bold;display:block; margin-bottom:0.3em;}
    .field { margin-bottom: 1.5em; }
    .desc, .status { color: #666; font-size: 0.95em; }
    .error { color: #b33; margin: 1em 0 0 0; font-weight: bold; }
    .success { color: #175c32; margin: 1em 0 0 0; font-weight: bold; }
    .summary { background: #eef4ff; border-radius: 7px; padding: 1em; margin-bottom: 1em; }
    pre.json { background: #f7f9fa; font-size: 0.88em; padding: 10px; border-radius: 7px;}
    /* Scoped Section Styling (see per-section for N6–N1) */
  </style>
  <script>
    // N7: App Globals
    // Will contain network config, global state, API endpoints, etc
    window.PFH = {
      XAMAN_SDK_URL: "https://xaman.app/assets/cdn/xumm.min.js",
      JCS_DEST: "rPU6sXCNzsjcTUEmgJQ5SxDUzY2y1RyYKd", // Official JCS recipient
      JCS_ISSUER: "rPU6sXCNzsjcTUEmgJQ5SxDUzY2y1RyYKd",
      JCS_CURRENCY: "JCS",
      XRP_USD_API: "https://api.coingecko.com/api/v3/simple/price?ids=ripple&vs_currencies=usd",
      MIN_USD: 0.01, MAX_USD: 0.25,
      price: { xrp_usd: 3.10, updated: null }, // Defaults; will auto-refresh
      current: {},
      isMobile: function() {
        return /android|ipad|iphone|ipod/i.test(navigator.userAgent);
      }
    };
    // Utility to fetch live price; called on page load and periodically.
    async function fetchXrpPrice() {
      try {
        const res = await fetch(PFH.XRP_USD_API);
        const data = await res.json();
        PFH.price.xrp_usd = data.ripple.usd;
        PFH.price.updated = new Date();
        document.dispatchEvent(new Event('xrpPriceUpdate'));
      } catch (e) { /* Network fail: leave price as is */ }
    }
    setInterval(fetchXrpPrice, 30000);
    document.addEventListener("DOMContentLoaded", fetchXrpPrice);
  </script>
</head>
<body>
  <div class="container">
    <!-- N6: Header/Brand Section -->
    <section id="n6-header">
      <h1>Pennies From Heaven</h1>
      <div class="desc">Submit a prayer to the XRP Ledger for <strong>$0.01–$0.25</strong> in JCS Token.</div>
    </section>
    <style>
      #n6-header { text-align:center; margin-bottom:2em;}
      #n6-header .desc { margin-top:0.5em;}
    </style>
    
    <!-- N5: Wallet Connection -->
    <section id="n5-wallet">
      <div id="n5-wallet-ui">
        <button id="n5-connect-btn" class="btn">Connect Wallet (Xumm/Xaman)</button>
        <div id="n5-wallet-status" class="status">Wallet not connected.</div>
        <div id="n5-wallet-details" style="display:none;">
          <div>Connected: <span id="n5-wallet-address"></span></div>
          <div id="n5-trustline-status"></div>
        </div>
      </div>
    </section>
    <style>
      #n5-wallet { margin: 1.25em 0; text-align:center;}
      #n5-wallet-details { margin-top:0.9em; color:#255de6; font-size:0.97em; }
      #n5-trustline-status { margin-top:0.4em;}
    </style>
    <script src="https://xaman.app/assets/cdn/xumm.min.js"></script>
    <script>
      // N5: Wallet Connection JS
      // Connect wallet button
      const connectBtn = document.getElementById('n5-connect-btn');
      const walletStatus = document.getElementById('n5-wallet-status');
      const walletDetails = document.getElementById('n5-wallet-details');
      const walletAddress = document.getElementById('n5-wallet-address');
      const trustlineStatus = document.getElementById('n5-trustline-status');

      let xumm = null, account = null;

      connectBtn.addEventListener('click', async () => {
        connectBtn.disabled = true; walletStatus.innerText = "Launching Xumm/Xaman...";
        xumm = new Xumm(); // empty for frontend flows, no API keys!
        account = null;
        try {
          const ping = await xumm.ping();
          account = ping?.sdk?.account || null;
          if(account) {
            walletStatus.innerText = "Wallet connected.";
            walletDetails.style.display = "";
            walletAddress.innerText = account;
            PFH.current.account = account;
            await checkTrustline();
          } else {
            walletStatus.innerText = "Wallet connection failed.";
            connectBtn.disabled = false;
          }
        } catch (e) {
          walletStatus.innerText = "Failed to connect. Try again.";
          connectBtn.disabled = false;
        }
      });

      async function checkTrustline() {
        trustlineStatus.innerText = "Checking JCS Trustline...";
        try {
          const lines = await fetch(
            `https://xrplcluster.com/accounts/${account}/lines`
          ).then(r => r.json());
          const jcsLine = lines?.result?.lines?.find(
            l => l.account === PFH.JCS_ISSUER && l.currency === PFH.JCS_CURRENCY
          );
          if (!jcsLine) {
            trustlineStatus.innerHTML = 
              `<span style="color:#BB5A1E;">No JCS Trustline. Please <a target="_blank" href="https://xrpl.to/trustset/jesus-christ-saves-ministry-jcs">add trustline</a> using Xumm/Xaman.&nbsp;</span>`;
            PFH.current.hasJcsTrustline = false;
          } else {
            trustlineStatus.innerHTML = `<span style="color:#17842a;">JCS Trustline active.</span>`;
            PFH.current.hasJcsTrustline = true;
          }
        } catch {
          trustlineStatus.innerHTML = `<span style="color:#b00;">Trustline check error.</span>`;
          PFH.current.hasJcsTrustline = false;
        }
      }
    </script>
    <!-- ========== N7: Payment UI and Cost Calculation ========== -->
<section id="n7-payment" class="n7-section">
  <h2>Send Your Prayer to the XRP Ledger</h2>
  <form id="n7-payment-form" class="n7-form">
    <div class="n7-row">
      <label for="n7-amount">Choose Donation:</label>
      <input type="range" min="0.01" max="0.25" step="0.01" id="n7-amount" name="amount" value="0.10" />
      <span class="n7-amount-display"><span id="n7-amount-usd">0.10</span> USD</span>
    </div>
    <div class="n7-row">
      <label for="n7-prayer">Your Prayer:</label>
      <textarea id="n7-prayer" name="prayer" maxlength="150" rows="3" placeholder="Type your prayer here..."></textarea>
    </div>
    <div class="n7-row">
      <span>Current Rate:</span>
      <span id="n7-xrp-rate">Fetching...</span>
    </div>
    <div class="n7-row">
      <span>Amount in XRP:</span>
      <span id="n7-amount-xrp">--</span>
    </div>
    <div class="n7-row">
      <span>Amount in JCS:</span>
      <span id="n7-amount-jcs">--</span>
    </div>
    <button id="n7-pay-btn" type="submit" disabled>Submit Prayer & Pay</button>
  </form>
  <div id="n7-transaction-status" class="n7-status"></div>
  <div id="n7-payload-display" class="n7-payload"></div>
</section>

    <!-- N4: Prayer Submission + Payment Form -->
    <section id="n4-prayer-form">
      <form id="n4-form" autocomplete="off">
        <div class="field">
          <label for="n4-prayer" class="label">Your Prayer</label>
          <textarea id="n4-prayer" name="prayer" rows="5" placeholder="Type your prayer here..." maxlength="180"></textarea>
          <div id="n4-char-count" class="desc"></div>
        </div>
        <div class="field">
          <label for="n4-slider" class="label">Amount to Give (USD)</label>
          <input type="range" id="n4-slider" min="1" max="25" value="5" step="1">
          <span id="n4-usd-amt" style="font-weight:600;"></span>
          <span id="n4-jcs-amt"></span>
        </div>
        <div id="n4-summary" class="summary" style="display:none;"></div>
        <div>
          <button type="submit" id="n4-submit-btn" class="btn">Review &amp; Send Prayer</button>
        </div>
        <div id="n4-form-error" class="error"></div>
      </form>
    </section>
    <style>
      #n4-prayer-form .field { margin-bottom:1.15em;margin-top:0.7em;}
      #n4-prayer { width:99%; font-size:1.05em; }
      #n4-slider { width: 65%; }
      #n4-char-count { margin-top:0.2em; font-size:0.92em;}
    </style>
    <script>
      // N4: Prayer Form JS
      const prayerArea = document.getElementById('n4-prayer');
      const charCount = document.getElementById('n4-char-count');
      const usdAmount = document.getElementById('n4-usd-amt');
      const jcsAmount = document.getElementById('n4-jcs-amt');
      const slider = document.getElementById('n4-slider');
      const summary = document.getElementById('n4-summary');
      const form = document.getElementById('n4-form');
      const formError = document.getElementById('n4-form-error');
      let currentUsd = 0.05;

      function updateAmounts() {
        const usd = Number(slider.value) / 100;
        currentUsd = usd;
        const xrp = usd / PFH.price.xrp_usd;
        const jcs = xrp.toFixed(6);
        usdAmount.textContent = `$${usd.toFixed(2)}`;
        jcsAmount.textContent = ` (${jcs} JCS Tokens)`;
        PFH.current.usd = usd;
        PFH.current.jcs = jcs;
        PFH.current.prayer = prayerArea.value;
      }

      slider.addEventListener('input', updateAmounts);
      document.addEventListener('xrpPriceUpdate', updateAmounts);
      prayerArea.addEventListener('input', () => {
        charCount.textContent = `Characters: ${prayerArea.value.length}/180`;
      });

      form.addEventListener('submit', function(e){
        e.preventDefault();
        formError.textContent = "";
        if(!xumm || !PFH.current.account) {
          formError.textContent = "Connect your wallet first!";
          return;
        }
        if(!PFH.current.hasJcsTrustline) {
          formError.textContent = "You must set a JCS trustline.";
          return;
        }
        if(!prayerArea.value.trim()) {
          formError.textContent = "Prayer text cannot be empty.";
          return;
        }
        // Confirm summary
        summary.innerHTML = `<b>Prayer Preview:</b> ${prayerArea.value.replace(/</g,"&lt;")} <br>
          <b>Amount:</b> $${currentUsd.toFixed(2)} (${PFH.current.jcs} JCS)`;
        summary.style.display = "";
        showTransactionPreview();
      });
      updateAmounts();
    </script>
    
    <!-- N3: Transaction Preview/Summary -->
    <section id="n3-preview" style="display:none;">
      <div class="summary">
        <div><b>Destination:</b> <span id="n3-dest"></span></div>
        <div><b>Token:</b> JCS <small>(Issuer: <span id="n3-issuer"></span>)</small></div>
        <div><b>Memo (hex):</b> <code id="n3-memo"></code></div>
        <div><b>Amount:</b> <span id="n3-payamt"></span></div>
      </div>
      <button id="n3-send-btn" class="btn">Send Payment</button>
      <button id="n3-back-btn" class="btn" style="background:#aaa;">Back</button>
      <div id="n3-pre-error" class="error"></div>
    </section>
    <style>
      #n3-preview { margin:1.5em 0; }
    </style>
    <script>
      // N3: Show/handle preview, allow confirm/back
      const n3Preview = document.getElementById('n3-preview');
      const n3Dest = document.getElementById('n3-dest');
      const n3Issuer = document.getElementById('n3-issuer');
      const n3Memo = document.getElementById('n3-memo');
      const n3Payamt = document.getElementById('n3-payamt');
      const n3SendBtn = document.getElementById('n3-send-btn');
      const n3BackBtn = document.getElementById('n3-back-btn');
      const n3PreError = document.getElementById('n3-pre-error');
      function hexMemo(str) {
        return Array.from(new TextEncoder().encode(str)).map(b=>b.toString(16).padStart(2,'0')).join('');
      }
      function showTransactionPreview() {
        const prayer = PFH.current.prayer;
        n3Memo.textContent = hexMemo(prayer);
        n3Dest.textContent = PFH.JCS_DEST;
        n3Issuer.textContent = PFH.JCS_ISSUER;
        n3Payamt.textContent = `${PFH.current.jcs} JCS`;
        n3Preview.style.display = "";
        document.getElementById('n4-prayer-form').style.display = "none";
      }
      n3BackBtn.onclick = function(){
        n3Preview.style.display = "none";
        document.getElementById('n4-prayer-form').style.display = "";
      }
      n3SendBtn.onclick = async function() {
        n3PreError.textContent = "";
        try {
          // Compose Xumm Payload
          const txjson = {
            TransactionType: "Payment",
            Destination: PFH.JCS_DEST,
            Amount: {
              currency: PFH.JCS_CURRENCY,
              issuer: PFH.JCS_ISSUER,
              value: PFH.current.jcs
            },
            Memos: [{ Memo: { MemoData: hexMemo(PFH.current.prayer) } }]
          };
          // Create payload for sign request
          const payload = await xumm.payload.create({
            txjson,
            options: {
              submit: true
            },
            custom_meta: {
              instruction: "Sign to submit your prayer to the XRP Ledger"
            }
          });
          PFH.current.payload = payload;
          showDeliverySection(payload);
        } catch (e) {
          n3PreError.textContent = "Could not start sign request. Try again."
        }
      }
    </script>
    
    <!-- N2: Transaction Delivery (Deep Link / QR) -->
    <section id="n2-tx-delivery" style="display:none;">
      <div class="summary">
        <div id="n2-delivery-desc"></div>
        <canvas id="n2-qr-canvas" width="200" height="200" style="display:none;"></canvas>
        <a id="n2-dl-link" class="btn" href="#" style="display:none;">Open in Xumm/Xaman</a>
        <div id="n2-status" class="status"></div>
        <button id="n2-cancel-btn" class="btn" style="background:#c00;">Cancel</button>
      </div>
    </section>
    <style>
      #n2-tx-delivery .summary {text-align:center;}
      #n2-qr-canvas {margin-top:1em;}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script>
      // N2: Show transaction delivery method (deep link vs qr), subscribe for result
      const n2Section = document.getElementById('n2-tx-delivery');
      const n2DlLink = document.getElementById('n2-dl-link');
      const n2QrCanvas = document.getElementById('n2-qr-canvas');
      const n2Status = document.getElementById('n2-status');
      const n2Cancel = document.getElementById('n2-cancel-btn');
      function showDeliverySection(payload) {
        document.getElementById('n3-preview').style.display = "none";
        n2Section.style.display = "";
        const mobile = PFH.isMobile();
        const url = payload.next.always;
        if (mobile) {
          n2DlLink.href = url;
          n2DlLink.style.display = "";
          document.getElementById('n2-delivery-desc').textContent = "Tap to sign your prayer in Xumm/Xaman.";
          n2QrCanvas.style.display = "none";
        } else {
          // Show QR
          const qr = qrcode(0, 'L');
          qr.addData(url);
          qr.make();
          n2QrCanvas.style.display = "";
          n2DlLink.style.display = "none";
          n2QrCanvas.getContext('2d').clearRect(0,0,200,200);
          const tileW = 200 / qr.getModuleCount();
          for (let row = 0; row < qr.getModuleCount(); row++) {
            for (let col = 0; col < qr.getModuleCount(); col++) {
              if(qr.isDark(row,col)) {
                n2QrCanvas.getContext('2d').fillRect(col*tileW,row*tileW,tileW,tileW);
              }
            }
          }
          document.getElementById('n2-delivery-desc').textContent = "Scan with Xumm/Xaman to sign and submit this prayer.";
        }
        n2Status.innerText = "Waiting for signature...";
        // Subscribe to payload
        (async function(){
          await xumm.payload.subscribe(payload.uuid, event=>{
            if(event.data.opened) n2Status.innerText = "Sign request opened.";
            if(typeof event.data.signed !== 'undefined') {
              if(event.data.signed) {
                n2Status.innerText = "Prayer sent! Preparing result.";
                showResult(payload);
              } else {
                n2Status.innerText = "Signing rejected.";
              }
              n2Cancel.style.display = "";
            }
          });
        })();
      }
      n2Cancel.onclick = ()=>{
        n2Section.style.display = "none";
        document.getElementById('n4-prayer-form').style.display = "";
      }
    </script>
    
    <!-- N1: Result/Final Status -->
    <section id="n1-result" style="display:none;">
      <div id="n1-success" class="success"></div>
      <div id="n1-details"></div>
      <button id="n1-another" class="btn">Submit Another Prayer</button>
    </section>
    <style>
      #n1-result { text-align:center; margin-top:2em;}
    </style>
    <script>
      // N1: Show transaction result
      const n1Section = document.getElementById('n1-result');
      const n1Success = document.getElementById('n1-success');
      const n1Details = document.getElementById('n1-details');
      const n1Another = document.getElementById('n1-another');
      async function showResult(payload) {
        n2Section.style.display = "none";
        n1Section.style.display = "";
        n1Success.innerText = "Your prayer has been submitted to the XRPL!";
        n1Details.innerHTML = `
          <a href="https://xrpscan.com/tx/${payload.refs.tx_hash}" target="_blank">
            View Transaction on XRPL Explorer
          </a>`;
      }
      n1Another.onclick = function() {
        n1Section.style.display = "none";
        document.getElementById('n4-prayer-form').style.display = "";
        prayerArea.value = "";
        updateAmounts();
      }
    </script>
    
  </div>
</body>
</html>


